<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Ai-Arrhythmia Prediction</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  </head>
  <body>
    <main class="page">
      <header class="app-header">
        <div class="topbar">
          <div class="topbar-main">
            <h1>Dashboard</h1>
            <p>Welcome, <strong><%= currentUser.fullName %></strong> (<%= currentUser.role %>)</p>
            <% if (currentUser) { %>
              <div class="redirect-row header-redirect-row">
                <a href="/dashboard" class="link-btn"><i data-lucide="layout-dashboard" class="icon"></i>Dashboard</a>
                <a href="/predict" class="ghost-link"><i data-lucide="activity" class="icon"></i>Prediction Form</a>
                <a href="/history" class="ghost-link"><i data-lucide="history" class="icon"></i>Prediction History</a>
              </div>
            <% } %>
          </div>
          <div class="topbar-actions">
            <form method="POST" action="/logout">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <button type="submit" class="ghost-btn"><i data-lucide="log-out" class="icon"></i>Logout</button>
            </form>
          </div>
        </div>
      </header>
      <section class="panel">
        <% if (typeof forbiddenMessage !== 'undefined' && forbiddenMessage) { %>
          <div class="alert alert-error"><%= forbiddenMessage %></div>
        <% } %>

        <% 
          const safeDashboardData = (typeof dashboardData !== 'undefined' && dashboardData) ? dashboardData : {};
          const safeCanPredict = (typeof canPredict !== 'undefined')
            ? Boolean(canPredict)
            : Boolean(currentUser);
          const data = safeDashboardData;
          const registeredUsers = Array.isArray(data.registeredUsers) ? data.registeredUsers : [];
          const classCounts = {
            N: Number((data.classCounts && data.classCounts.N) || 0),
            SVEB: Number((data.classCounts && data.classCounts.SVEB) || 0),
            VEB: Number((data.classCounts && data.classCounts.VEB) || 0),
            F: Number((data.classCounts && data.classCounts.F) || 0),
            Q: Number((data.classCounts && data.classCounts.Q) || 0),
          };
          const recent = Array.isArray(data.recentPredictions) ? data.recentPredictions : [];
          const alerts = Array.isArray(data.highRiskAlerts) ? data.highRiskAlerts : [];
          const sortedAlerts = [...alerts].sort((a, b) => {
            const aVeb = Number(a && a.probabilities && a.probabilities.VEB);
            const bVeb = Number(b && b.probabilities && b.probabilities.VEB);
            const safeA = Number.isFinite(aVeb) ? aVeb : -1;
            const safeB = Number.isFinite(bVeb) ? bVeb : -1;
            return safeB - safeA;
          });
          const trendLabels = Array.isArray(data.trendLabels) ? data.trendLabels : [];
          const trendScores = Array.isArray(data.trendScores) ? data.trendScores : [];
          const trendTopClass = String(data.trendTopClass || '').toUpperCase();
          const trendTopCount = Number(data.trendTopCount || 0);
          const trendSecondClass = String(data.trendSecondClass || '').toUpperCase();
          const trendSecondCount = Number(data.trendSecondCount || 0);
          const trendTopClassLabel = ({
            N: 'Normal',
            SVEB: 'SVEB',
            VEB: 'VEB',
            F: 'Fusion',
            Q: 'Unknown',
          }[trendTopClass]) || 'N/A';
          const trendSecondClassLabel = ({
            N: 'Normal',
            SVEB: 'SVEB',
            VEB: 'VEB',
            F: 'Fusion',
            Q: 'Unknown',
          }[trendSecondClass]) || 'N/A';
          const trendTopChipClass = ({
            N: 'status-chip-n',
            SVEB: 'status-chip-sveb',
            VEB: 'status-chip-veb',
            F: 'status-chip-f',
            Q: 'status-chip-q',
          }[trendTopClass]) || 'status-chip-default';

          const statusMap = {
            N: { label: 'Normal', chip: 'status-chip-n' },
            SVEB: { label: 'SVEB', chip: 'status-chip-sveb' },
            VEB: { label: 'VEB', chip: 'status-chip-veb' },
            F: { label: 'Fusion', chip: 'status-chip-f' },
            Q: { label: 'Unknown', chip: 'status-chip-q' },
          };

          function fmtPercent(value) {
            return Number.isFinite(Number(value)) ? (Number(value) * 100).toFixed(1) + '%' : '--';
          }

          function bestProb(entry) {
            if (!entry || !entry.probabilities) return null;
            const vals = Object.values(entry.probabilities).map(Number).filter((v) => Number.isFinite(v));
            if (!vals.length) return null;
            return Math.max(...vals);
          }

          function normalizeLabel(value) {
            const label = String(value || '').trim().toUpperCase();
            if (label === 'N' || label.includes('NORMAL')) return 'N';
            if (label === 'SVEB' || label.includes('SUPRAVENT')) return 'SVEB';
            if (label === 'VEB' || label.includes('VENTRIC')) return 'VEB';
            if (label === 'F' || label.includes('FUSION')) return 'F';
            if (label === 'Q' || label.includes('UNKNOWN') || label.includes('UNCLASS')) return 'Q';
            return 'Q';
          }

          function timeAgo(dateValue) {
            if (!dateValue) return 'Unknown';
            const date = new Date(dateValue);
            const diffMins = Math.max(1, Math.floor((Date.now() - date.getTime()) / 60000));
            if (diffMins < 60) return diffMins + ' min ago';
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return diffHours + ' hr ago';
            const diffDays = Math.floor(diffHours / 24);
            return diffDays + ' day ago';
          }
        %>

        <% if (safeCanPredict) { %>
          <section class="dashboard-stats-grid">
            <article class="dashboard-stat-card">
              <div class="dashboard-stat-icon dashboard-stat-number"><%= data.totalScans || 0 %></div>
              <p class="dashboard-stat-label">Total Scans</p>
            </article>

            <% if (currentUser.role === 'admin') { %>
              <article class="dashboard-stat-card">
                <div class="dashboard-stat-icon dashboard-stat-number"><%= data.totalUsersRegistered || registeredUsers.length || 0 %></div>
                <p class="dashboard-stat-label">Registered Users</p>
              </article>
            <% } %>

            <article class="dashboard-stat-card dashboard-class-card <%= currentUser.role !== 'admin' ? 'dashboard-class-card-wide' : '' %>">
              <div class="dashboard-stat-icon dashboard-stat-number is-warning">CC</div>
              <p class="dashboard-stat-label">Class Cases</p>
              <div class="dashboard-class-counts">
                <div class="dashboard-class-item"><span class="status-chip status-chip-n">N</span><strong><%= classCounts.N %></strong></div>
                <div class="dashboard-class-item"><span class="status-chip status-chip-sveb">SVEB</span><strong><%= classCounts.SVEB %></strong></div>
                <div class="dashboard-class-item"><span class="status-chip status-chip-veb">VEB</span><strong><%= classCounts.VEB %></strong></div>
                <div class="dashboard-class-item"><span class="status-chip status-chip-f">F</span><strong><%= classCounts.F %></strong></div>
                <div class="dashboard-class-item"><span class="status-chip status-chip-q">Q</span><strong><%= classCounts.Q %></strong></div>
              </div>
            </article>
          </section>

          <% if (currentUser.role === 'admin') { %>
            <section class="dashboard-widget">
              <div class="dashboard-widget-head">
                <h2>Registered User Names</h2>
                <span class="muted-note"><%= data.totalUsersRegistered || registeredUsers.length || 0 %> users</span>
              </div>
              <% if (!registeredUsers.length) { %>
                <p class="muted-note">No users registered yet.</p>
              <% } else { %>
                <label class="field">
                  <span>Search User</span>
                  <input id="adminUserSearch" type="text" placeholder="Search by name, username, or role" />
                </label>
                <ul id="adminUserList" class="dashboard-recent-list">
                  <% registeredUsers.forEach((user) => { %>
                    <% const searchText = `${user.fullName || ''} ${user.username || ''} ${user.role || ''}`.toLowerCase(); %>
                    <% 
                      const userRole = String(user.role || '').toLowerCase();
                      const roleChipClass = ({
                        admin: 'status-chip-f',
                        doctor: 'status-chip-sveb',
                        patient: 'status-chip-n',
                      }[userRole]) || 'status-chip-default';
                      const roleBoxClass = ({
                        admin: 'admin-user-role-admin',
                        doctor: 'admin-user-role-doctor',
                        patient: 'admin-user-role-patient',
                      }[userRole]) || 'admin-user-role-default';
                    %>
                    <li class="dashboard-recent-item admin-user-item <%= roleBoxClass %>" data-search="<%= searchText %>">
                      <div class="dashboard-recent-left">
                        <span class="status-chip <%= roleChipClass %>"><%= (user.role || 'user').toUpperCase() %></span>
                        <div>
                          <p class="dashboard-recent-title"><%= user.fullName || user.username %></p>
                          <p class="muted-note">@<%= user.username %></p>
                          <% const userClassCounts = user.classCounts || { N: 0, SVEB: 0, VEB: 0, F: 0, Q: 0 }; %>
                          <% const userTotalScans = Number(userClassCounts.N || 0) + Number(userClassCounts.SVEB || 0) + Number(userClassCounts.VEB || 0) + Number(userClassCounts.F || 0) + Number(userClassCounts.Q || 0); %>
                          <p class="muted-note">Total Scans: <strong><%= userTotalScans %></strong></p>
                          <div class="admin-user-class-counts" aria-label="Class counts for <%= user.username %>">
                            <div class="admin-user-class-item"><span class="status-chip status-chip-n">N</span><strong><%= Number(userClassCounts.N || 0) %></strong></div>
                            <div class="admin-user-class-item"><span class="status-chip status-chip-sveb">SVEB</span><strong><%= Number(userClassCounts.SVEB || 0) %></strong></div>
                            <div class="admin-user-class-item"><span class="status-chip status-chip-veb">VEB</span><strong><%= Number(userClassCounts.VEB || 0) %></strong></div>
                            <div class="admin-user-class-item"><span class="status-chip status-chip-f">F</span><strong><%= Number(userClassCounts.F || 0) %></strong></div>
                            <div class="admin-user-class-item"><span class="status-chip status-chip-q">Q</span><strong><%= Number(userClassCounts.Q || 0) %></strong></div>
                          </div>
                        </div>
                      </div>
                      <div class="dashboard-recent-actions">
                        <% if (user.username !== currentUser.username) { %>
                          <form method="POST" action="/admin/users/<%= user._id %>/delete" class="admin-user-delete-form" onsubmit="return confirm('Delete this user and all their prediction history?');">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                            <button type="submit" class="ghost-btn delete admin-user-delete-btn">
                              <i data-lucide="trash-2" class="icon"></i>Delete
                            </button>
                          </form>
                        <% } else { %>
                          <span class="muted-note">Current User</span>
                        <% } %>
                      </div>
                    </li>
                  <% }) %>
                </ul>
                <p id="adminUserNoResults" class="muted-note" style="display: none;">No users found for this search.</p>
              <% } %>
            </section>
          <% } %>

          <section class="dashboard-action-row">
            <a href="/predict" class="dashboard-action-btn primary"><i data-lucide="activity" class="icon"></i>Analyze New ECG</a>
            <a href="/history" class="dashboard-action-btn"><i data-lucide="history" class="icon"></i>Review History</a>
          </section>

          <section class="dashboard-main-grid">
            <div class="dashboard-column-main">
              <article class="dashboard-widget">
                <div class="dashboard-widget-head">
                  <h2>Recent Predictions</h2>
                  <a href="/history" class="ghost-link">View All</a>
                </div>

                <% if (!recent.length) { %>
                  <p class="muted-note">No predictions available yet.</p>
                <% } else { %>
                  <ul class="dashboard-recent-list">
                    <% recent.forEach((entry) => { 
                      const code = normalizeLabel(entry.predictionLabel);
                      const status = statusMap[code] || { label: code || 'Unknown', chip: 'status-chip-q' };
                      const confidence = bestProb(entry);
                    %>
                      <li class="dashboard-recent-item">
                        <div class="dashboard-recent-left">
                          <span class="status-chip <%= status.chip %>"><%= status.label %></span>
                          <div>
                            <p class="dashboard-recent-title">Beat classified as <%= status.label %></p>
                            <p class="muted-note"><%= timeAgo(entry.createdAt) %></p>
                          </div>
                        </div>
                        <strong class="dashboard-recent-confidence"><%= confidence !== null ? (confidence * 100).toFixed(1) + '%' : '--' %></strong>
                      </li>
                    <% }) %>
                  </ul>
                <% } %>
              </article>

              <article class="dashboard-widget">
                <div class="dashboard-widget-head">
                  <h2>Risk Trend</h2>
                  <div class="dashboard-trend-meta">
                    <% if (trendTopCount > 0) { %>
                      <span class="status-chip <%= trendTopChipClass %>">Top: <%= trendTopClassLabel %> (<%= trendTopCount %>)</span>
                    <% } %>
                    <div class="dashboard-trend-subrow">
                      <span class="muted-note">Last 12 scans</span>
                      <% if (trendSecondCount > 0) { %>
                        <span class="muted-note dashboard-trend-second">2nd: <%= trendSecondClassLabel %> (<%= trendSecondCount %>)</span>
                      <% } %>
                    </div>
                  </div>
                </div>
                <div class="dashboard-chart-wrap">
                  <canvas id="dashboardRiskChart" aria-label="Risk trend chart" role="img"></canvas>
                </div>
              </article>
            </div>

            <aside class="dashboard-column-side">
              <article class="dashboard-widget">
                <div class="dashboard-widget-head">
                  <h2>High Risk Alerts</h2>
                </div>
                <% if (!sortedAlerts.length) { %>
                  <p class="muted-note">No high-risk cases detected recently.</p>
                <% } else { %>
                  <ul class="dashboard-alert-list">
                    <% sortedAlerts.forEach((entry) => { %>
                      <li class="dashboard-alert-item">
                        <div>
                          <p class="dashboard-alert-title">VEB detected</p>
                          <p class="muted-note"><%= timeAgo(entry.createdAt) %></p>
                        </div>
                        <span class="status-chip status-chip-veb"><%= fmtPercent(entry.probabilities && entry.probabilities.VEB) %></span>
                      </li>
                    <% }) %>
                  </ul>
                <% } %>
              </article>

              <article class="dashboard-widget">
                <div class="dashboard-widget-head">
                  <h2>Model Status</h2>
                </div>
                <ul class="dashboard-model-list">
                  <li>
                    <span>System</span>
                    <strong class="dashboard-model-pill <%= data.modelStatus && data.modelStatus.isActive ? 'is-active' : 'is-inactive' %>">
                      <%= data.modelStatus && data.modelStatus.isActive ? 'Active' : 'Offline' %>
                    </strong>
                  </li>
                  <li><span>Model Accuracy</span><strong><%= (data.modelStatus && data.modelStatus.accuracy) || 99 %>%</strong></li>
                  <li><span>Last Scan</span><strong><%= timeAgo(data.modelStatus && data.modelStatus.lastScanAt) %></strong></li>
                </ul>
              </article>

            </aside>
          </section>
        <% } else { %>
          <h2>Role Actions</h2>
          <ul class="role-actions">
            <% actions.forEach(function(action) { %>
              <li><%= action %></li>
            <% }) %>
          </ul>
          <p class="muted-note">Please login to access prediction features.</p>
        <% } %>
      </section>
    </main>
    <script id="dashboardTrendData" type="application/json"><%- JSON.stringify({ labels: (safeDashboardData && safeDashboardData.trendLabels) || [], scores: (safeDashboardData && safeDashboardData.trendScores) || [] }) %></script>
    <script>
      window.addEventListener('DOMContentLoaded', function () {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
          window.lucide.createIcons();
        }

        const chartCanvas = document.getElementById('dashboardRiskChart');
        const trendPayload = document.getElementById('dashboardTrendData');
        let trendLabels = [];
        let trendScores = [];

        if (trendPayload && trendPayload.textContent) {
          try {
            const parsed = JSON.parse(trendPayload.textContent);
            trendLabels = Array.isArray(parsed.labels) ? parsed.labels : [];
            trendScores = Array.isArray(parsed.scores) ? parsed.scores : [];
          } catch (error) {
            trendLabels = [];
            trendScores = [];
          }
        }

        if (chartCanvas && window.Chart && trendLabels.length && trendScores.length) {
          const css = getComputedStyle(document.documentElement);
          const stroke = css.getPropertyValue('--accent').trim() || '#4f9da6';
          const grid = css.getPropertyValue('--line').trim() || '#24343d';
          const text = css.getPropertyValue('--muted').trim() || '#9ab0bf';

          new window.Chart(chartCanvas, {
            type: 'line',
            data: {
              labels: trendLabels,
              datasets: [{
                label: 'Risk Score',
                data: trendScores,
                borderColor: stroke,
                backgroundColor: 'rgba(79, 157, 166, 0.18)',
                pointRadius: 3,
                pointHoverRadius: 5,
                tension: 0.35,
                fill: true,
              }],
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: {
                  min: 0,
                  max: 100,
                  grid: { color: grid },
                  ticks: { color: text },
                },
                x: {
                  grid: { color: 'transparent' },
                  ticks: { color: text },
                },
              },
            },
          });
        }

        const adminUserSearch = document.getElementById('adminUserSearch');
        const adminUserList = document.getElementById('adminUserList');
        const noResults = document.getElementById('adminUserNoResults');

        if (adminUserSearch && adminUserList) {
          const userItems = Array.from(adminUserList.querySelectorAll('.dashboard-recent-item'));

          const applyUserFilter = function () {
            const query = String(adminUserSearch.value || '').trim().toLowerCase();
            let visibleCount = 0;

            userItems.forEach(function (item) {
              const haystack = String(item.getAttribute('data-search') || '');
              const isVisible = !query || haystack.includes(query);
              item.style.display = isVisible ? '' : 'none';
              if (isVisible) {
                visibleCount += 1;
              }
            });

            if (noResults) {
              noResults.style.display = visibleCount ? 'none' : '';
            }
          };

          adminUserSearch.addEventListener('input', applyUserFilter);
        }
      });
    </script>
  </body>
</html>
