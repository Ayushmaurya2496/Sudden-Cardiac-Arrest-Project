<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Holter Beat Prediction</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="page">
      <section class="panel">
        <div class="topbar">
          <div>
            <h1>Arrhythmia-Ai Prediction</h1>
            <p>Signed in as <strong><%= currentUser.fullName %></strong> (<%= currentUser.role %>)</p>
          </div>
          <div class="topbar-actions">
            <a href="/dashboard" class="ghost-link">Dashboard</a>
            <a href="/history" class="ghost-link">History</a>
            <form method="POST" action="/logout">
              <button type="submit" class="ghost-btn">Logout</button>
            </form>
          </div>
        </div>

        <p>Enter the arrhythmia features below to classify the beat type.</p>

        <div class="redirect-row">
          <a href="/dashboard" class="link-btn">Redirect to Dashboard</a>
          <a href="/predict" class="ghost-link">New Prediction Form</a>
          <a href="/history" class="ghost-link">View History</a>
        </div>

        <section class="upload-box">
          <h2>Upload Arrhythmia Image</h2>
          <p>Select an ECG/arrhythmia image file to upload.</p>
          <form method="POST" action="/upload-image" enctype="multipart/form-data" class="upload-form" id="image-upload-form">
            <label class="field">
              <span>Image File (JPG, PNG, WEBP)</span>
              <input type="file" name="ecgImage" accept="image/*" required id="ecg-image-input" />
            </label>
            <div class="upload-actions">
              <button type="submit" class="ghost-btn">Upload Image</button>
              <button type="button" class="submit analyze-btn" id="analyze-image-btn">Analyze with AI</button>
            </div>
          </form>
          <p class="analyze-status" id="analyze-status"></p>
        </section>

        <% if (uploadError) { %>
          <div class="alert alert-error"><%= uploadError %></div>
        <% } %>

        <% if (uploadSuccess) { %>
          <div class="alert alert-success">
            <p class="label"><%= uploadSuccess %></p>
            <% if (uploadedImageUrl) { %>
              <img src="<%= uploadedImageUrl %>" alt="Uploaded arrhythmia" class="uploaded-preview" />
            <% } %>
          </div>
        <% } %>

        <% if (errors.length) { %>
          <div class="alert alert-error">
            <ul>
              <% errors.forEach(function(message) { %>
                <li><%= message %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <form method="POST" action="/predict" class="form-grid" id="predict-form">
          <% featureNames.forEach(function(name) { %>
            <label class="field">
              <span><%= name %></span>
              <input
                type="number"
                name="<%= name %>"
                step="any"
                value="<%= values[name] || '' %>"
                required
              />
            </label>
          <% }) %>
          <button type="submit" class="submit">Predict Beat Type</button>
          <% if (prediction) { %>
            <div class="alert alert-success prediction-result">
              <div class="prediction-core">
                <h2>Prediction</h2>
                <p class="label">Predicted Class: <strong><%= prediction.readableLabel %></strong></p>
                <p>ID: <%= prediction.label_id %></p>
                <% if (prediction.probabilities) { %>
                  <div class="probabilities">
                    <% Object.entries(prediction.probabilities).forEach(function(entry) { %>
                      <div class="prob-row">
                        <span><%= entry[0] %></span>
                        <span><%= (entry[1] * 100).toFixed(2) %>%</span>
                      </div>
                    <% }) %>
                  </div>
                <% } %>
              </div>
              <div class="prediction-description">
                <h3>Class Insight</h3>
                <p><%= predictionDescription || 'No additional context available.' %></p>
              </div>
            </div>
          <% } %>
        </form>
      </section>
    </main>
    <script src="/predict.js" defer></script>
  </body>
</html>
